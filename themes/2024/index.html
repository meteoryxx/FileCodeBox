<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/assets/logo_small.png" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"
  />
  <meta name="description" content="{{description}}" />
  <meta name="keywords" content="{{keywords}}" />
  <meta name="generator" content="FileCodeBox2.2" />
  <link rel="manifest" href="/assets/manifest.json" />
  <meta name="github" content="https://github.com/vastsa/FileCodeBox" />
  <title>{{title}}</title>
  <script type="module" crossorigin src="/assets/index-B-Ka-o3f.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-CVaRI27s.css">
  <style>
    /* FileCodeBox ç®€åŒ–å¯†ç æ’ä»¶æ ·å¼ */
    .fcb-simple-password {
      margin: 8px 0;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .fcb-simple-password input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: rgba(255,255,255,0.9);
      color: #374151;
      min-width: 150px;
      z-index: 1000;
      position: relative;
    }
    .fcb-simple-password input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      z-index: 1001;
    }
    .fcb-simple-password button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      background: #6366f1;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .fcb-simple-password button:hover {
      background: #5b21b6;
    }
    .fcb-simple-password button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div id="app"></div>

<script>
// FileCodeBox ç®€åŒ–å¯†ç æ’ä»¶
(function() {
  'use strict';
  
  if (window.FileCodeBoxSimplePlugin) return;
  window.FileCodeBoxSimplePlugin = true;
  
  let isGuestUploadEnabled = true;
  let hasAddedField = false;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆtokenï¼ˆåŒ…å«æ—¶é—´æˆ³éªŒè¯ï¼‰
  function hasValidToken() {
    const token = localStorage.getItem('token');
    const tokenTimestamp = localStorage.getItem('token_timestamp');
    
    if (!token || !tokenTimestamp) {
      return false;
    }
    
    // æ£€æŸ¥tokenæ˜¯å¦è¶…è¿‡30å¤©
    const fiveDaysInMs = 30 * 24 * 60 * 60 * 1000;
    const now = Date.now();
    const tokenAge = now - parseInt(tokenTimestamp);
    
    if (tokenAge > fiveDaysInMs) {
      console.log('ğŸ•’ Tokenå·²è¿‡æœŸï¼Œè‡ªåŠ¨æ¸…ç†');
      localStorage.removeItem('token');
      localStorage.removeItem('token_timestamp');
      return false;
    }
    
    return true;
  }
  
  // è®¾ç½®tokenï¼ˆåŒæ—¶ä¿å­˜æ—¶é—´æˆ³ï¼‰
  function setToken(token) {
    localStorage.setItem('token', token);
    localStorage.setItem('token_timestamp', Date.now().toString());
    console.log('âœ… Tokenå·²ä¿å­˜ï¼Œæ—¶é—´æˆ³:', new Date().toLocaleString());
  }
  
  // è·å–ç³»ç»Ÿé…ç½®
  async function getSystemConfig() {
    try {
      const response = await fetch('/', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      if (response.ok) return (await response.json()).detail;
    } catch (error) {
      console.warn('è·å–é…ç½®å¤±è´¥:', error);
    }
    return null;
  }
  
  // åˆ›å»ºç®€åŒ–å¯†ç å­—æ®µ
  function createSimplePasswordField() {
    const container = document.createElement('div');
    container.className = 'fcb-simple-password';
    container.id = 'fcb-simple-password';
    
    // è®¾ç½®æ›´é«˜çš„å±‚çº§å’Œå®šä½ï¼Œç¡®ä¿äº‹ä»¶ä¼˜å…ˆçº§
    container.style.cssText = `
      position: relative;
      z-index: 9999;
      margin: 8px 0;
      display: flex;
      gap: 8px;
    `;
    
     container.innerHTML = `
          <input type="password" id="fcb-admin-password" placeholder="ç®¡ç†å‘˜å¯†ç " autocomplete="off" style="position: relative;z-index: 10000;height: 47px;">
          <button type="button" id="fcb-login-btn"  style=" width: 130px; height: 45px; font-size: 26px; " >ç™»å½•</button>
        `;
    
    const loginBtn = container.querySelector('#fcb-login-btn');
    const passwordInput = container.querySelector('#fcb-admin-password');
    
    const handleLogin = async () => {
      const password = passwordInput.value.trim();
      if (!password) { alert('è¯·è¾“å…¥å¯†ç '); return; }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';
      
      try {
        const response = await fetch('/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password })
        });
        
        if (response.ok) {
          const data = await response.json();
          setToken(data.detail.token);  // ä½¿ç”¨æ–°çš„setTokenå‡½æ•°
          container.style.display = 'none';
          console.log('âœ… ç™»å½•æˆåŠŸ');
        } else {
          alert('å¯†ç é”™è¯¯');
          loginBtn.disabled = false;
          loginBtn.textContent = 'ç™»å½•';
        }
      } catch (error) {
        alert('ç½‘ç»œé”™è¯¯');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    };
    
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
    
    // å¼ºåˆ¶äº‹ä»¶éš”ç¦» - é˜²æ­¢ç²˜è´´äº‹ä»¶è¢«å…¶ä»–å…ƒç´ æ•è·
    passwordInput.addEventListener('paste', (e) => {
      e.stopImmediatePropagation();
      e.preventDefault();
      
      // æ‰‹åŠ¨å¤„ç†ç²˜è´´
      const clipboardData = e.clipboardData || window.clipboardData;
      const pastedData = clipboardData.getData('text');
      passwordInput.value = pastedData;
      
      console.log('âœ… å¯†ç ç²˜è´´äº‹ä»¶å·²æˆåŠŸéš”ç¦»å¹¶å¤„ç†');
    });
    
    // å¼ºåŒ–ç„¦ç‚¹ç®¡ç†
    passwordInput.addEventListener('focus', (e) => {
      e.stopImmediatePropagation();
      console.log('âœ… å¯†ç è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹');
    });
    
    passwordInput.addEventListener('blur', (e) => {
      e.stopImmediatePropagation();
    });
    
    // é˜²æ­¢é”®ç›˜äº‹ä»¶å¹²æ‰°
    passwordInput.addEventListener('keydown', (e) => {
      e.stopImmediatePropagation();
    });
    
    passwordInput.addEventListener('keyup', (e) => {
      e.stopImmediatePropagation();
    });
    
    passwordInput.addEventListener('input', (e) => {
      e.stopImmediatePropagation();
    });
    
    return container;
  }
  
  // æ·»åŠ å¯†ç å­—æ®µåˆ°æ•°å­—è¾“å…¥æ¡†åé¢
  function addPasswordField() {
    if (hasAddedField || hasValidToken()) return;
    
    const numberInput = document.querySelector('input[type="number"]');
    if (!numberInput) {
      setTimeout(addPasswordField, 1000);
      return;
    }
    
    const passwordField = createSimplePasswordField();
    let targetContainer = numberInput.closest('.flex.flex-col.space-y-3') || numberInput.parentElement;
    
    if (targetContainer) {
      targetContainer.appendChild(passwordField);
      hasAddedField = true;
      console.log('âœ… å¯†ç å­—æ®µå·²æ·»åŠ ');
      
      // æ·»åŠ æ¡ä»¶æ€§ç²˜è´´äº‹ä»¶æ‹¦æˆªï¼Œåªåœ¨ç‰¹å®šé¡µé¢ç”Ÿæ•ˆ
      setTimeout(() => {
        const passwordInput = document.getElementById('fcb-admin-password');
        if (passwordInput) {
          // æ£€æŸ¥å½“å‰é¡µé¢è·¯å¾„ï¼Œåªåœ¨éæ ¹ç›®å½•é¡µé¢å¯ç”¨é˜²ç²˜è´´
          const shouldPreventPaste = () => {
            const currentPath = window.location.hash || window.location.pathname;
            // å¦‚æœæ˜¯æ ¹ç›®å½• /#/ æˆ–å–ä»¶é¡µé¢ï¼Œå…è®¸æ­£å¸¸ç²˜è´´
            return !(currentPath === '#/' || currentPath === '/' || currentPath.includes('#/send') || currentPath.includes('/send'));
          };
          
          // æ¡ä»¶æ€§ç¦ç”¨é¡µé¢å…¶ä»–å…ƒç´ çš„ç²˜è´´äº‹ä»¶
          const originalPasteHandler = (e) => {
            if (e.target !== passwordInput && e.target.id !== 'fcb-admin-password') {
              // åªåœ¨éœ€è¦çš„é¡µé¢é˜»æ­¢ç²˜è´´
              if (shouldPreventPaste()) {
                console.log('âš ï¸ é˜»æ­¢å…¶ä»–å…ƒç´ çš„ç²˜è´´äº‹ä»¶:', e.target);
                e.stopImmediatePropagation();
                e.preventDefault();
              } else {
                console.log('âœ… å…è®¸åœ¨å½“å‰é¡µé¢ç²˜è´´:', window.location.hash);
              }
            }
          };
          
          // åœ¨æ•è·é˜¶æ®µæ‹¦æˆªæ‰€æœ‰ç²˜è´´äº‹ä»¶
          document.addEventListener('paste', originalPasteHandler, true);
          
          // ç¡®ä¿å¯†ç è¾“å…¥æ¡†èƒ½æ­£å¸¸å¤„ç†ç²˜è´´
          passwordInput.addEventListener('paste', (e) => {
            console.log('âœ… å¯†ç è¾“å…¥æ¡†æ­£åœ¨å¤„ç†ç²˜è´´äº‹ä»¶');
          });
          
          console.log('âœ… æ¡ä»¶æ€§ç²˜è´´äº‹ä»¶æ‹¦æˆªå·²è®¾ç½®');
        }
      }, 100);
    }
  }
  
  function removePasswordField() {
    const field = document.getElementById('fcb-simple-password');
    if (field) { field.remove(); hasAddedField = false; }
  }
  
  // æ‹¦æˆªä¸Šä¼ è¯·æ±‚æ·»åŠ è®¤è¯
  const originalFetch = window.fetch;
  window.fetch = async function(url, options = {}) {
    const isUploadApi = typeof url === 'string' && url.includes('/share/') && 
                       (url.includes('/text/') || url.includes('/file/') || url.includes('/chunk/'));
    
    if (isUploadApi && !isGuestUploadEnabled) {
      const token = localStorage.getItem('token');
      const passwordInput = document.getElementById('fcb-admin-password');
      const password = passwordInput ? passwordInput.value.trim() : '';
      
      if (!options.headers) options.headers = {};
      
      if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
      } else if (password) {
        if (url.includes('/chunk/')) {
          options.headers['X-Admin-Password'] = password;
        } else if (options.body instanceof FormData) {
          options.body.append('password', password);
        }
      }
    }
    
    try {
      const response = await originalFetch(url, options);
      if (isUploadApi && !isGuestUploadEnabled && response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('token_timestamp');  // åŒæ—¶æ¸…ç†æ—¶é—´æˆ³
        if (!hasAddedField) addPasswordField();
      }
      return response;
    } catch (error) {
      throw error;
    }
  };
  
  // æ£€æŸ¥çŠ¶æ€å¹¶æ·»åŠ /ç§»é™¤å¯†ç å­—æ®µ
  async function checkStatus() {
    const config = await getSystemConfig();
    if (config) {
      const newState = config.openUpload === 1;
      if (newState !== isGuestUploadEnabled) {
        isGuestUploadEnabled = newState;
        if (!isGuestUploadEnabled && !hasValidToken()) {
          addPasswordField();
        } else {
          removePasswordField();
        }
      }
    }
  }
  
  // åˆå§‹åŒ–
  function init() {
    // é¦–å…ˆæ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
    hasValidToken();
    
    checkStatus();
    setInterval(checkStatus, 3000);
    
    if (window.MutationObserver) {
      const observer = new MutationObserver(() => {
        if (!hasAddedField && !isGuestUploadEnabled && !hasValidToken()) {
          setTimeout(addPasswordField, 500);
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    setTimeout(init, 1000);
  }
  
})();
</script>

</body>
</html>
